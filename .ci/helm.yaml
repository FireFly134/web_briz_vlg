include: '/.ci/base.yaml'

build helm:
  extends: .build_base
  stage: build
  variables:
    IMAGE_TAG: $HELM_IMAGE_TAG
    DOCKERFILE: shared/dockerfiles/helm
    CHANGES_PATH: shared/helm/**/*
    LINT_SCRIPT: "helmfile lint"
#    LINT_SCRIPT: "helmfile lint && kube-linter lint ./main/templates --add-all-built-in"

deploy helm:
    extends: .lint_base
    stage: deploy
    variables:
        IMAGE_TAG: $HELM_IMAGE_TAG
        DOCKERFILE: shared/dockerfiles/helm
        CHANGES_PATH: shared/helm/**/*
        KUBECONFIG_PATH: '/usr/local/app/kubectl_conf.yaml'
        DEPLOY_SCRIPT: |
          echo $$KUBECONFIG_CONTENT | base64 -d >> $$KUBECONFIG
          chmod go-r $$KUBECONFIG
          echo -n "$$SECRETS_CRT" >> ./sealed-secrets-wrapper/tls.crt
          echo -n "$$SECRETS_KEY" >> ./sealed-secrets-wrapper/tls.key
          if [[ "$DRY_RUN" == "true" ]]; then helmfile sync --args '--dry-run'; else helmfile apply; fi
    needs:
        - job: 'build helm'
          optional: true
        - job: 'build web'
          optional: true
        - job: 'test new web'
          optional: true
    rules:
        - if: $CI_COMMIT_REF_NAME != "main"
          variables:
            DRY_RUN: 'true'
        - !reference [.lint_base, rules]
        - changes:
            - shared/dockerfiles/web
            - shared/dockerfiles/web.dockerignore
            - ui/web/**/*
    script:
        - docker run
            -e KUBECONFIG=$KUBECONFIG_PATH
            -e KUBECONFIG_CONTENT=$KUBECONFIG
            -e DEPLOY_SCRIPT="$DEPLOY_SCRIPT"
            -e SECRETS_KEY="$SECRETS_KEY"
            -e SECRETS_CRT="$SECRETS_CRT"
            -e DRY_RUN="$DRY_RUN"
            $IMAGE_TAG sh -c "$DEPLOY_SCRIPT"
