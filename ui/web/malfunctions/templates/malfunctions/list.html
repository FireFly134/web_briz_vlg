{% extends 'main/base.html' %}
{% block title %}Cписок сервисных заявок{% endblock %}
{% block style %}
<style>.doc_table {
  font-size: 12pt;
  font-family: Arial;
  color: black;
}</style>
{% endblock %}

{% block body %}

<br>
<div class="d-flex justify-content-between align-items-center" style="margin-left: 25px; margin-right: 25px;">
	<div class="btn-group" role="group" aria-label="Первая группа">
		<button type="button" class="btn btn-primary mt-3" onclick="filterTableButton('True')" id="btn-group-1">Активные заявки</button>
		<button type="button" class="btn btn-secondary mt-3" onclick="filterTableButton('False')" id="btn-group-2">Архив заявок</button>
		<a href="{% url 'create' %}" class="btn btn-success mt-3" id="btn-group-4">Создать новую заявку</a>

	</div>
</div>
<div style="margin-left: 25px; margin-right: 25px;">
	<input type="text" id="filterInput" placeholder="Введите значение для фильтрации" oninput="handleInput(event)"  style="width: 500px;">
	<input type="image" src="/static/admin/img/icon-deletelink.svg" alt="Очистить фильтр" title="Очистить фильтр" onclick="NullFilterTable()" style="width: 20px; height: 20px; margin-top: -10px;">
</div>
<table class="table_center_by_css table table-sm table-bordered" border="1" cellpadding="1" cellspacing="1" style="width:98%" id="Table">
	<thead style="position: sticky;top: 0">
		<tr>
			<td class="doc_table" scope="col" style="background: #ebebeb;text-align:center; width:50px"></td>
			<td class="doc_table" scope="col" style="background: #ebebeb;text-align:center; width:300px;"></td>
			<td class="doc_table" scope="col" style="background: #ebebeb;text-align:center; width:50px;"></td>
			<td class="doc_table" scope="col" style="background: #ebebeb;text-align:center;"></td>
			<td class="doc_table" scope="col" style="background: #ebebeb;text-align:center; width:300px;">Заявка принята</td>
			<td class="doc_table" scope="col" style="background: #ebebeb;text-align:center;">Заявка принята</td>
			<td class="doc_table" scope="col" style="background: #ebebeb;text-align:center;">Заявка принята</td>
			<td class="doc_table" scope="col" style="background: #ebebeb;text-align:center;">Заявка передана</td>
			<td class="doc_table" scope="col" style="background: #ebebeb;text-align:center;">Заявка передана</td>
			<td class="doc_table" scope="col" style="background: #ebebeb;text-align:center;">Статус заявки</td>
			<td class="doc_table" scope="col" style="background: #ebebeb;text-align:center;">Статус заявки</td>
			<td class="doc_table" scope="col" style="background: #ebebeb;text-align:center;">Статус заявки</td>
			<td class="doc_table" scope="col" style="background: #ebebeb;text-align:center;">Статус заявки</td>
			<td class="doc_table" scope="col" style="background: #ebebeb;text-align:center;"></td>
			<td class="doc_table" scope="col" style="background: #ebebeb;text-align:center; width:100px"></td>
			<td class="doc_table" scope="col" style="display: none"></td>
		</tr>
		<tr>
			<td class="doc_table" scope="col" id="N" data-column="N" style="background: #ebebeb;text-align:center; width:50px">№ п/п</td>
			<td class="doc_table" scope="col" id="address" data-column="address" style="background: #ebebeb;text-align:center; width:300px;">Адрес</td>
			<td class="doc_table" scope="col" id="num_house" data-column="num_house" style="background: #ebebeb;text-align:center; width:50px;">Номер дома</td>
			<td class="doc_table" scope="col" id="entrance" data-column="entrance" style="background: #ebebeb;text-align:center;">Подъезд</td>
			<td class="doc_table" scope="col" id="flat_or_tel" data-column="flat_or_tel" style="background: #ebebeb;text-align:center; width:300px;">Номер квартины или телефона</td>
			<td class="doc_table" scope="col" id="dispatcher" data-column="dispatcher" style="background: #ebebeb;text-align:center;">ФИО диспетчера</td>
						<td class="doc_table" scope="col" id="date_time_accepted" data-column="date_time_accepted" style="background: #ebebeb;text-align:center;">Дата и время приема заявки</td>
			<td class="doc_table" scope="col" id="mechanics" data-column="mechanics" style="background: #ebebeb;text-align:center;">ФИО механика</td>
						<td class="doc_table" scope="col" id="date_time_transfer" data-column="date_time_accepted" style="background: #ebebeb;text-align:center;">Дата и время передачи заявки</td>
			<td class="doc_table" scope="col" id="date_time_closed" data-column="date_time_closed" style="background: #ebebeb;text-align:center;">Дата и время закрытия заявки</td>
			<td class="doc_table" scope="col" id="simple" data-column="date_time_closed" style="background: #ebebeb;text-align:center;">Простой</td>
			<td class="doc_table" scope="col" id="malfunction_and_cause" data-column="malfunction_and_cause" style="background: #ebebeb;text-align:center;">Неисправность и причина заявки</td>
			<td class="doc_table" scope="col" id="transfer_of_the_application" data-column="transfer_of_the_application" style="background: #ebebeb;text-align:center;">Передача по смене</td>
			<td class="doc_table" scope="col" id="description" data-column="description" style="background: #ebebeb;text-align:center;">Примечания</td>
			<td class="doc_table" scope="col" id="move" style="background: #ebebeb;text-align:center; width:100px">Действия</td>
			<td class="doc_table" scope="col" id="status" style="display: none">status</td>
		</tr>
	</thead>
	<tbody id="tbody"></tbody>
</table>
{% endblock %}
{% block script %}
<script>
	let rowCounter = 1; // Счетчик номера п/п
	//
	function formatDate(date) {
    const options = { day: 'numeric', month: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric' };
    return new Intl.DateTimeFormat('ru-RU', options).format(date);
}
	function addTableRow(id, address, num_house, entrance, flat_or_tel, date_time_accepted, dispatcher, mechanics, date_time_closed, malfunction_and_cause, transfer_of_the_application, description, status, date_time_transfer, simple) {
		// Форматирование даты date_time_accepted
		const formattedDateAccepted = date_time_accepted !== 'None' ? formatDate(new Date(date_time_accepted)) : '';

		// Форматирование даты date_time_transfer
		const formattedDateTransfer = date_time_transfer !== 'None' ? formatDate(new Date(date_time_transfer)) : '';

		// Проверка и форматирование даты date_time_closed
		const formattedDateClosed = date_time_closed !== 'None' ? formatDate(new Date(date_time_closed)) : '';

		const edit_url = `/malfunctions/edit/${id}`
		const delete_url = `/malfunctions/delete/${id}`
		const newRow = tbody.insertRow();
		const cell1 = newRow.insertCell(0);
		const cell2 = newRow.insertCell(1);
		const cell3 = newRow.insertCell(2);
		const cell4 = newRow.insertCell(3);
		const cell5 = newRow.insertCell(4);
		const cell6 = newRow.insertCell(5);
		const cell7 = newRow.insertCell(6);
		const cell8 = newRow.insertCell(7);
		const cell9 = newRow.insertCell(8);
		const cell10 = newRow.insertCell(9);
		const cell11 = newRow.insertCell(10);
		const cell12 = newRow.insertCell(11);
		const cell13 = newRow.insertCell(12);
		const cell14 = newRow.insertCell(13);
		const cell15 = newRow.insertCell(14);
		const cell16 = newRow.insertCell(15);

		cell1.textContent = rowCounter++;
		cell2.textContent = address;
		cell3.textContent = num_house;
		cell4.textContent = entrance;
		cell5.textContent = flat_or_tel;
		cell6.textContent = dispatcher;
		cell7.textContent = formattedDateAccepted;
		cell8.textContent = mechanics;
		cell9.textContent = formattedDateTransfer;
		cell10.textContent = formattedDateClosed;
		cell11.textContent = simple;
		cell12.textContent = malfunction_and_cause !== 'None' ? malfunction_and_cause : '';
		cell13.textContent = transfer_of_the_application === 'True' ? 'Передано по смене' : '';
		cell14.textContent = description !== 'None' ? description : '';
		cell16.textContent = status;
		cell16.style.display = "none";


		// Создаем ссылку для редактирования
		const editLink = document.createElement("a");
		editLink.href = edit_url;
		editLink.className = "btn btn-link";
		editLink.title = "Редактировать";

		// Создаем иконку для редактирования
		const editIcon = document.createElement("i");
		editIcon.className = "fas fa-pencil-alt";

		// Добавляем иконку в ссылку
		editLink.appendChild(editIcon);

		// Создаем ссылку для удаления
		const deleteLink = document.createElement("a");
		deleteLink.href = delete_url;
		deleteLink.className = "btn btn-link text-danger";
		deleteLink.title = "Удалить";

		// Создаем иконку для удаления
		const deleteIcon = document.createElement("i");
		deleteIcon.className = "fas fa-trash-alt";

		// Добавляем иконку в ссылку
		deleteLink.appendChild(deleteIcon);

		// Добавляем ссылки в ячейку
		cell15.appendChild(editLink);
<!--		cell15.appendChild(deleteLink);-->
	}

	//Фильтр по значениям в таблице открыт договор и строительная готовность, работает через кнопки
	function NullFilterTable() {
	// Обновляем значение скрытого поля
		document.getElementById('filterInput').value = '';
		filterTable()
		}
	function filterTable(inputElement = document.getElementById("filterInput").value) {
	  var filter, table, tr, td, i, j, txtValue;
	  filter = inputElement.toUpperCase();
	  table = document.getElementById("Table");
	  tr = table.getElementsByTagName("tr");

	  // Проходим по каждой строке таблицы, начиная с индекса 2 (пропускаем первые две строки)
	  for (i = 1; i < tr.length; i++) {
		td = tr[i].getElementsByTagName("td");
		var rowVisible = false;
		for (j = 0; j < td.length; j++) {
		  if (td[j]) {
			txtValue = td[j].textContent || td[j].innerText;

			if (txtValue.toUpperCase().indexOf(filter) > -1) {
			  rowVisible = true;
			  break;
			}
		  }
		}

		// Показываем или скрываем строку в зависимости от значения флага
		tr[i].style.display = rowVisible ? "" : "none";
	  }
	}
	function handleInput(event) {
		filterTable(event.target.value);
	}

	document.addEventListener("DOMContentLoaded", function () {
		let tbody = document.getElementById('tbody');

		{% for item in list %}
			addTableRow(`{{ item.id|safe }}`, `{{ item.address|safe }}`, `{{ item.num_house|safe }}`, `{{ item.entrance|safe }}`, `{{ item.flat_or_tel|safe }}`, `{{ item.date_time_accepted|safe }}`, `{{ item.dispatcher|safe }}`, `{% for mechanic in item.mechanics.all %}{{ mechanic.fio|safe }}{% if not forloop.last %}\n{% endif %}{% endfor %}`, `{{ item.date_time_closed|safe }}`, `{{ item.malfunction_and_cause|safe }}`, `{{ item.transfer_of_the_application|safe }}`, `{{ item.description|safe }}`, `{{ item.status|safe }}`, `{{ item.date_time_transfer|safe }}`, `{{ item.simple|safe }}`);
		{% endfor %}
	});
</script>
<script src="/media/js/filter_table.js"></script>
{% endblock %}